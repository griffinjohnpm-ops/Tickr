// --- CONFIGURATION & STATE ---
const CONFIG = {
    // Uses localStorage if available, otherwise falls back to defaults
    zip: localStorage.getItem('sb_zip') || '10001', 
    teams: localStorage.getItem('sb_teams') || 'Yankees, Lakers, AAPL, BTC',
    weatherKey: localStorage.getItem('sb_weather_key') || '',
    // YOUR KEY IS HERE:
    trafficKey: localStorage.getItem('sb_traffic_key') || 'ARaYAc62yz5pTcFDbPVybq8Ile2z7wdY',
};

// Default coordinates (NYC) - updated automatically if Weather API works
let currentLat = 40.7128; 
let currentLon = -74.0060;

document.addEventListener('DOMContentLoaded', () => {
    initClock();
    runDashboard(); 
    
    // UI Event Listeners
    document.getElementById('btn-fullscreen').onclick = toggleFullScreen;
    document.getElementById('btn-settings').onclick = () => toggleModal(true);
    document.getElementById('btn-close').onclick = () => toggleModal(false);
    document.getElementById('btn-save').onclick = saveSettings;

    // Load current settings into inputs
    document.getElementById('setting-zip').value = CONFIG.zip;
    document.getElementById('setting-teams').value = CONFIG.teams;
    document.getElementById('setting-weather-key').value = CONFIG.weatherKey;
    document.getElementById('setting-traffic-key').value = CONFIG.trafficKey;
});

async function runDashboard() {
    await initWeather(); 
    await initTicker(); 
}

// --- 1. CLOCK ---
function initClock() {
    function update() {
        const now = new Date();
        document.getElementById('clock-display').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('date-display').innerText = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
    setInterval(update, 1000);
    update();
}

// --- 2. WEATHER ---
async function initWeather() {
    const displayTemp = document.getElementById('weather-temp');
    const displayDesc = document.getElementById('weather-desc');
    const displayLoc = document.getElementById('weather-loc');

    if (!CONFIG.weatherKey) {
        displayTemp.innerText = "72°F";
        displayDesc.innerText = "Demo Mode";
        displayLoc.innerText = `Zip: ${CONFIG.zip} (No Key)`;
        return; 
    }

    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?zip=${CONFIG.zip},us&units=imperial&appid=${CONFIG.weatherKey}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.cod === 200) {
            displayTemp.innerText = Math.round(data.main.temp) + "°F";
            displayDesc.innerText = data.weather[0].main;
            displayLoc.innerText = data.name;
            
            // CRITICAL: Update coordinates so Traffic API knows where to look
            currentLat = data.coord.lat;
            currentLon = data.coord.lon;
        }
    } catch (e) { console.error("Weather Error", e); }
}

// --- 3. TICKER (Traffic + News) ---
async function initTicker() {
    const tape = document.getElementById('ticker-tape');
    const headline = document.getElementById('headline-display');
    let tickerItems = [];

    // A. FETCH TRAFFIC (TomTom)
    if (CONFIG.trafficKey) {
        try {
            // Create a 0.2 degree bounding box around the location
            const diff = 0.1; 
            const bbox = `${currentLon-diff},${currentLat-diff},${currentLon+diff},${currentLat+diff}`;
            
            // TomTom Incident API
            const trafficUrl = `https://api.tomtom.com/traffic/services/4/incidentDetails/s3/${bbox}/10/-1/json?key=${CONFIG.trafficKey}&language=en-US`;
            
            const res = await fetch(trafficUrl);
            const data = await res.json();
            
            let trafficFound = false;
            if (data.incidents && data.incidents.length > 0) {
                // Add up to 3 major incidents to the ticker
                data.incidents.slice(0, 3).forEach(inc => {
                    tickerItems.push(`<span class="ticker-item ticker-down">⚠ TRAFFIC: ${inc.d}</span>`);
                    trafficFound = true;
                });
            } 
            
            if (!trafficFound) {
                tickerItems.push(`<span class="ticker-item ticker-highlight">TRAFFIC: No major delays in local area</span>`);
            }

        } catch (e) { 
            console.log("Traffic Error", e);
            tickerItems.push(`<span class="ticker-item ticker-down">TRAFFIC DATA ERROR</span>`);
        }
    }

    // B. FETCH NEWS (RSS via rss2json)
    // Sources: ESPN (Sports), Fox (News), NYT (World)
    const rssUrls = [
        'https://www.espn.com/espn/rss/news', 
        'https://moxie.foxnews.com/google-publisher/latest.xml'
    ];
    
    let newsItems = [];

    for (let url of rssUrls) {
        try {
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
            const data = await res.json();
            if(data.items) newsItems = [...newsItems, ...data.items];
        } catch (e) { console.log("RSS Error", e); }
    }

    // Filter by Favorites
    const favorites = CONFIG.teams.split(',').map(s => s.trim().toLowerCase());
    const relevantNews = newsItems.filter(item => {
        const text = (item.title + item.description).toLowerCase();
        return favorites.some(fav => text.includes(fav));
    });

    // C. BUILD DISPLAY
    // Priority Headline Logic
    if (relevantNews.length > 0) {
        headline.innerText = relevantNews[0].title;
        relevantNews.forEach(item => tickerItems.push(`<span class="ticker-item ticker-highlight">★ ${item.title}</span>`));
    } else if (newsItems.length > 0) {
        headline.innerText = newsItems[0].title;
    } else {
        headline.innerText = "Waiting for News...";
    }

    // Add Filler News
    newsItems.slice(0, 10).forEach(item => {
        tickerItems.push(`<span class="ticker-item">${item.title}</span>`);
    });

    // Render & Loop
    const finalHtml = tickerItems.join("");
    // We duplicate the content to ensure the scrolling animation is smooth
    tape.innerHTML = finalHtml + finalHtml; 
}

// --- UTILITIES ---
function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
}

function toggleModal(show) {
    const modal = document.getElementById('settings-modal');
    if(show) modal.classList.remove('hidden');
    else modal.classList.add('hidden');
}

function saveSettings() {
    localStorage.setItem('sb_zip', document.getElementById('setting-zip').value);
    localStorage.setItem('sb_teams', document.getElementById('setting-teams').value);
    localStorage.setItem('sb_weather_key', document.getElementById('setting-weather-key').value);
    localStorage.setItem('sb_traffic_key', document.getElementById('setting-traffic-key').value);
    location.reload();
}
