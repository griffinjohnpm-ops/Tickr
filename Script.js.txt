// --- CONFIGURATION & STATE ---
const CONFIG = {
    zip: localStorage.getItem('sb_zip') || '10001',
    teams: localStorage.getItem('sb_teams') || 'NY Yankees, LAL, AAPL',
    weatherKey: localStorage.getItem('sb_weather_key') || '',
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    initClock();
    initWeather();
    initTicker();
    
    // Event Listeners
    document.getElementById('btn-fullscreen').onclick = toggleFullScreen;
    document.getElementById('btn-settings').onclick = () => toggleModal(true);
    document.getElementById('btn-close').onclick = () => toggleModal(false);
    document.getElementById('btn-save').onclick = saveSettings;

    // Pre-fill inputs
    document.getElementById('setting-zip').value = CONFIG.zip;
    document.getElementById('setting-teams').value = CONFIG.teams;
    document.getElementById('setting-weather-key').value = CONFIG.weatherKey;
});

// --- 1. CLOCK ---
function initClock() {
    function update() {
        const now = new Date();
        document.getElementById('clock-display').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        document.getElementById('date-display').innerText = now.toLocaleDateString([], { weekday: 'long', month: 'short', day: 'numeric' });
    }
    setInterval(update, 1000);
    update();
}

// --- 2. WEATHER (OpenWeatherMap or Mock) ---
async function initWeather() {
    const displayTemp = document.getElementById('weather-temp');
    const displayDesc = document.getElementById('weather-desc');
    const displayLoc = document.getElementById('weather-loc');

    if (!CONFIG.weatherKey) {
        // DEMO MODE if no key provided
        displayTemp.innerText = "72°F";
        displayDesc.innerText = "Demo Mode (Enter Key)";
        displayLoc.innerText = `Zip: ${CONFIG.zip}`;
        return;
    }

    try {
        const url = `https://api.openweathermap.org/data/2.5/weather?zip=${CONFIG.zip},us&units=imperial&appid=${CONFIG.weatherKey}`;
        const res = await fetch(url);
        const data = await res.json();
        
        if (data.cod === 200) {
            displayTemp.innerText = Math.round(data.main.temp) + "°F";
            displayDesc.innerText = data.weather[0].main;
            displayLoc.innerText = data.name;
        } else {
            displayDesc.innerText = "Error";
        }
    } catch (e) {
        console.error("Weather Error", e);
    }
}

// --- 3. TICKER (RSS Feeds) ---
async function initTicker() {
    const tape = document.getElementById('ticker-tape');
    const headline = document.getElementById('headline-display');
    
    // We use a public RSS to JSON converter to get news without complex APIs
    // Sources: ESPN (Sports), NYT (News)
    const rssUrls = [
        'https://www.espn.com/espn/rss/news', 
        'https://moxie.foxnews.com/google-publisher/latest.xml'
    ];
    
    let allItems = [];

    // Fetch Feeds
    for (let url of rssUrls) {
        try {
            const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
            const data = await res.json();
            if(data.items) allItems = [...allItems, ...data.items];
        } catch (e) { console.log("Feed Error", e); }
    }

    // Filter by Favorites (Teams/Stocks)
    const favorites = CONFIG.teams.split(',').map(s => s.trim().toLowerCase());
    const relevantNews = allItems.filter(item => {
        const text = (item.title + item.description).toLowerCase();
        return favorites.some(fav => text.includes(fav));
    });

    // Generate HTML
    let html = "";
    
    // 1. Add "Traffic" simulation (Hard to get real text traffic without complex API)
    html += `<span class="ticker-item ticker-highlight">TRAFFIC: Normal delays near ${CONFIG.zip} area...</span>`;

    // 2. Add Filtered News
    if (relevantNews.length > 0) {
        // Update the big card with the most recent relevant story
        headline.innerText = relevantNews[0].title;
        
        relevantNews.forEach(item => {
            html += `<span class="ticker-item">★ ${item.title}</span>`;
        });
    } else {
        headline.innerText = allItems[0]?.title || "No specific team news found.";
    }

    // 3. Add General News (filler)
    allItems.slice(0, 5).forEach(item => {
        html += `<span class="ticker-item">${item.title}</span>`;
    });

    // Double the content to ensure smooth scrolling loop
    tape.innerHTML = html + html; 
}

// --- UTILITIES ---
function toggleFullScreen() {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else if (document.exitFullscreen) document.exitFullscreen();
}

function toggleModal(show) {
    const modal = document.getElementById('settings-modal');
    if(show) modal.classList.remove('hidden');
    else modal.classList.add('hidden');
}

function saveSettings() {
    const zip = document.getElementById('setting-zip').value;
    const teams = document.getElementById('setting-teams').value;
    const key = document.getElementById('setting-weather-key').value;

    localStorage.setItem('sb_zip', zip);
    localStorage.setItem('sb_teams', teams);
    localStorage.setItem('sb_weather_key', key);
    
    location.reload(); // Reload to apply changes
}